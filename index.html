<!DOCTYPE html>
<html>
<head>
    <title>Web Linux GUI</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* Hide scrollbars */
        }
        #screen {
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="screen"></canvas>
    <script>
        var ws = new WebSocket("ws://localhost:8080/ws");
        var screen = document.getElementById('screen');
        var ctx = screen.getContext('2d');

        var scale = 1;
        var offsetX = 0;
        var offsetY = 0;
        var serverWidth = 1;
        var serverHeight = 1;
        var lastUpdate = null;

        function resizeCanvas() {
            screen.width = window.innerWidth;
            screen.height = window.innerHeight;
            drawScreenUpdate(lastUpdate);
        }
        window.addEventListener('resize', resizeCanvas, false);
        resizeCanvas();

        ws.onopen = function() { console.log("Connected"); };
        ws.onclose = function() { console.log("Disconnected"); };
        ws.onerror = function(err) { console.error(err); };

        function drawCursor(x, y) {
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, y + 14);
            ctx.lineTo(x + 10, y + 10);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }

        function drawScreenUpdate(update) {
            if (!update || !update.image) return;
            
            var img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, screen.width, screen.height);

                serverWidth = img.naturalWidth;
                serverHeight = img.naturalHeight;
                scale = Math.min(screen.width / serverWidth, screen.height / serverHeight);
                var newWidth = serverWidth * scale;
                var newHeight = serverHeight * scale;
                offsetX = (screen.width - newWidth) / 2;
                offsetY = (screen.height - newHeight) / 2;

                ctx.drawImage(img, offsetX, offsetY, newWidth, newHeight);

                // Draw the remote cursor
                var canvasMouseX = offsetX + (update.mouseX * scale);
                var canvasMouseY = offsetY + (update.mouseY * scale);
                drawCursor(canvasMouseX, canvasMouseY);
            };
            img.src = "data:image/jpeg;base64," + update.image;
        }

        ws.onmessage = function(e) {
            lastUpdate = JSON.parse(e.data);
            drawScreenUpdate(lastUpdate);
        };

        function sendEvent(event) {
            if (ws.readyState !== WebSocket.OPEN) return;
            
            var data = {
                type: event.type,
                key: event.key,
                keyCode: event.keyCode,
                button: event.button,
            };

            if (event.type.startsWith('mouse')) {
                if (event.clientX < offsetX || event.clientX > offsetX + (serverWidth * scale) ||
                    event.clientY < offsetY || event.clientY > offsetY + (serverHeight * scale)) {
                    return; 
                }
                data.x = Math.round((event.clientX - offsetX) / scale);
                data.y = Math.round((event.clientY - offsetY) / scale);
            }
            
            ws.send(JSON.stringify(data));
        }

        screen.addEventListener('mousemove', sendEvent);
        screen.addEventListener('mousedown', sendEvent);
        screen.addEventListener('mouseup', sendEvent);
        window.addEventListener('keydown', sendEvent);
        window.addEventListener('keyup', sendEvent);
    </script>
</body>
</html>
