<!DOCTYPE html>
<html>
<head>
    <title>Web Linux GUI</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* Hide scrollbars */
        }
        #screen {
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="screen"></canvas>
    <script>
        var ws = new WebSocket("ws://localhost:8080/ws");
        var screen = document.getElementById('screen');
        var ctx = screen.getContext('2d');

        // Global variables to store scaling and offset info
        var scale = 1;
        var offsetX = 0;
        var offsetY = 0;
        var serverWidth = 1;
        var serverHeight = 1;


        function resizeCanvas() {
            screen.width = window.innerWidth;
            screen.height = window.innerHeight;
            // When window resizes, redraw the last image with new dimensions
            drawScreenImage(lastImage);
        }

        var lastImage = null;
        window.addEventListener('resize', resizeCanvas, false);
        resizeCanvas(); // Initial resize

        ws.onopen = function() {
            console.log("Connected to WebSocket");
        };

        function drawScreenImage(img) {
            if (!img) return;
            
            ctx.clearRect(0, 0, screen.width, screen.height);

            serverWidth = img.naturalWidth;
            serverHeight = img.naturalHeight;

            // Calculate the best scale to fit the image within the canvas
            scale = Math.min(screen.width / serverWidth, screen.height / serverHeight);

            var newWidth = serverWidth * scale;
            var newHeight = serverHeight * scale;

            // Calculate offset to center the image
            offsetX = (screen.width - newWidth) / 2;
            offsetY = (screen.height - newHeight) / 2;

            ctx.drawImage(img, offsetX, offsetY, newWidth, newHeight);
        }


        ws.onmessage = function(e) {
            if (e.data instanceof Blob) {
                var url = URL.createObjectURL(e.data);
                var img = new Image();
                img.onload = function() {
                    lastImage = img;
                    drawScreenImage(img);
                    URL.revokeObjectURL(url);
                }
                img.src = url;
            } else {
                 console.log("Message from server: ", e.data);
            }
        };

        ws.onclose = function() {
            console.log("Disconnected from WebSocket");
        };

        ws.onerror = function(err) {
            console.error("WebSocket Error: ", err);
        };

        function sendEvent(event) {
            if (ws.readyState !== WebSocket.OPEN) {
                return;
            }
            
            var data = {
                type: event.type,
                key: event.key,
                keyCode: event.keyCode,
                button: event.button,
            };

            // Translate mouse coordinates
            if (event.type.startsWith('mouse')) {
                // Check if mouse is inside the scaled image
                if (event.clientX < offsetX || event.clientX > offsetX + (serverWidth * scale) ||
                    event.clientY < offsetY || event.clientY > offsetY + (serverHeight * scale)) {
                    return; // Do not send events outside the image bounds
                }
                data.x = Math.round((event.clientX - offsetX) / scale);
                data.y = Math.round((event.clientY - offsetY) / scale);
            }
            
            ws.send(JSON.stringify(data));
        }

        // Capture mouse events from the canvas
        screen.addEventListener('mousemove', sendEvent);
        screen.addEventListener('mousedown', sendEvent);
        screen.addEventListener('mouseup', sendEvent);

        // Capture keyboard events from the whole window
        window.addEventListener('keydown', sendEvent);
        window.addEventListener('keyup', sendEvent);

    </script>
</body>
</html>
