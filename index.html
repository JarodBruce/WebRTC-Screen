<!DOCTYPE html>
<html>
<head>
    <title>Web Linux GUI</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* Hide scrollbars */
        }
        #screen {
            display: block;
        }
        #menu {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
        }
        #menu button {
            margin-top: 5px;
            display: block;
            width: 100%;
        }
    </style>
</head>
<body>
    <canvas id="screen"></canvas>
    <div id="menu">
        <span>Menu</span>
        <button id="disconnectBtn">Disconnect</button>
    </div>

    <script>
        var ws = new WebSocket("ws://localhost:8080/ws");
        var screen = document.getElementById('screen');
        var ctx = screen.getContext('2d');

        var scale = 1;
        var offsetX = 0;
        var offsetY = 0;
        var serverWidth = 1;
        var serverHeight = 1;
        var lastUpdate = null;

        function resizeCanvas() {
            screen.width = window.innerWidth;
            screen.height = window.innerHeight;
            drawScreenUpdate(lastUpdate);
        }
        window.addEventListener('resize', resizeCanvas, false);
        resizeCanvas();

        ws.onopen = function() { console.log("Connected"); };
        ws.onclose = function() { 
            console.log("Disconnected"); 
            document.body.innerHTML = "<h1>Disconnected</h1>";
        };
        ws.onerror = function(err) { console.error(err); };

        function drawCursor(x, y) {
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, y + 14);
            ctx.lineTo(x + 10, y + 10);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }

        function drawScreenUpdate(update) {
            if (!update || !update.image) return;
            
            var img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, screen.width, screen.height);

                serverWidth = img.naturalWidth;
                serverHeight = img.naturalHeight;
                scale = Math.min(screen.width / serverWidth, screen.height / serverHeight);
                var newWidth = serverWidth * scale;
                var newHeight = serverHeight * scale;
                offsetX = (screen.width - newWidth) / 2;
                offsetY = (screen.height - newHeight) / 2;

                ctx.drawImage(img, offsetX, offsetY, newWidth, newHeight);

                // Draw the remote cursor
                var canvasMouseX = offsetX + (update.mouseX * scale);
                var canvasMouseY = offsetY + (update.mouseY * scale);
                drawCursor(canvasMouseX, canvasMouseY);
            };
            img.src = "data:image/jpeg;base64," + update.image;
        }

        ws.onmessage = function(e) {
            lastUpdate = JSON.parse(e.data);
            drawScreenUpdate(lastUpdate);
        };

        function sendEvent(event) {
            if (ws.readyState !== WebSocket.OPEN) return;
            
            // Prevent default browser actions for certain events
            if (event.type === 'contextmenu' || (event.type === 'keydown' && (event.ctrlKey || event.metaKey))) {
                event.preventDefault();
            }

            var data = {
                type: event.type,
                key: event.key,
                keyCode: event.keyCode,
                modifiers: [],
                deltaY: event.deltaY,
            };

            if (event.shiftKey) data.modifiers.push("shift");
            if (event.ctrlKey) data.modifiers.push("ctrl");
            if (event.altKey) data.modifiers.push("alt");
            // Note: 'metaKey' (Cmd/Windows key) is not typically supported by robotgo in the same way.

            if (event.type.startsWith('mouse') || event.type === 'wheel' || event.type === 'contextmenu') {
                 if (event.clientX < offsetX || event.clientX > offsetX + (serverWidth * scale) ||
                    event.clientY < offsetY || event.clientY > offsetY + (serverHeight * scale)) {
                    return; 
                }
                data.x = Math.round((event.clientX - offsetX) / scale);
                data.y = Math.round((event.clientY - offsetY) / scale);
            }

            if (event.type === 'mousedown' || event.type === 'mouseup' || event.type === 'contextmenu') {
                switch (event.button) {
                    case 0: data.button = "left"; break;
                    case 1: data.button = "center"; break;
                    case 2: data.button = "right"; break;
                }
            }
            
            ws.send(JSON.stringify(data));
        }

        document.getElementById('disconnectBtn').addEventListener('click', function() {
            ws.close();
        });

        // Paste event
        window.addEventListener('paste', function(e) {
            if (ws.readyState !== WebSocket.OPEN) return;
            e.preventDefault();
            var text = e.clipboardData.getData('text/plain');
            ws.send(JSON.stringify({
                type: 'paste',
                clipboardText: text,
            }));
        });

        screen.addEventListener('mousemove', sendEvent);
        screen.addEventListener('mousedown', sendEvent);
        screen.addEventListener('mouseup', sendEvent);
        screen.addEventListener('contextmenu', sendEvent); // For right-click
        screen.addEventListener('wheel', sendEvent);       // For scrolling
        window.addEventListener('keydown', sendEvent);
        window.addEventListener('keyup', sendEvent);
    </script>
</body>
</html>
